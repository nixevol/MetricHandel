# MetricHandel


## 技术栈

- **后端框架**: FastAPI + Uvicorn
- **数据处理**: Pandas
- **文件处理**: openpyxl, xlrd
- **数据库**: SQLite
- **打包工具**: PyInstaller

## 安装依赖

### 1. 确保 Python 版本

Python 3.10 或更高版本

### 2. 安装依赖库

```bash
pip install -r requirements.txt
```

依赖列表：
- `fastapi` - Web 框架
- `uvicorn` - ASGI 服务器
- `pandas` - 数据处理
- `openpyxl` - Excel 文件处理
- `xlrd` - Excel 文件读取
- `python-multipart` - 文件上传支持
- `pyinstaller` - 打包工具（可选，仅打包时需要）

## 运行程序

### 开发环境运行

```bash
python main.py
```

程序启动后会自动在浏览器中打开 `http://127.0.0.1:8000`

### 配置文件

程序首次运行时会自动创建 `config.ini` 配置文件，位于程序目录下。你可以编辑此文件自定义：

- **路径配置**：Data、DB、Models、Scripts 目录的位置
  - 支持绝对路径（如：`C:\Data`）
  - 支持相对路径（如：`./Data` 或 `../Data`）
  - 如果为空，则使用程序当前目录下的默认文件夹
  
- **服务器配置**：Web 服务器端口（默认 8000）

### 目录结构

程序运行时会使用以下目录（根据 `config.ini` 配置）：

```
项目目录/
├── main.py              # 主程序
├── config.ini           # 配置文件（首次运行自动创建）
├── Models/              # 模型配置文件目录（JSON文件）
├── Scripts/             # SQL脚本目录
├── DB/                  # 数据库目录（程序自动创建）
│   └── Data.db
└── Data/                # 数据文件目录（程序自动创建）
    └── (上传的文件)
```

## 打包为可执行文件

如果需要将程序打包为单文件 exe，可以按照以下步骤操作：

### 方法一：使用打包脚本（推荐）

```bash
python build.py
```

脚本会自动：
- 检查并安装 PyInstaller（如果未安装）
- 清理之前的构建文件
- 执行打包
- 显示打包结果

### 方法二：手动打包

1. 安装 PyInstaller（如果未安装）：
```bash
pip install pyinstaller
```

2. 执行打包命令：
```bash
pyinstaller build.spec --clean --noconfirm
```

### 打包结果

打包完成后，可执行文件位于：
```
dist/MetricHandel.exe
```

### 打包后的文件结构

打包后的 exe 文件是单文件版本，包含以下内容：

**打包进 exe 的内容**：
- `static/` - 前端静态文件（HTML/CSS/JS，自动解压）
- `Models/` - 模型配置文件目录（首次运行时会提取到配置的目录）
- `Scripts/` - SQL脚本目录（首次运行时会提取到配置的目录）
- `config.ini` - 配置文件模板（首次运行时会提取到程序目录）

**资源提取机制**：
- 程序首次运行时，会从 exe 中提取 `Models/` 和 `Scripts/` 目录到配置文件中指定的位置
- 如果配置的目录不存在，会创建目录并提取所有文件
- 如果配置的目录已存在，只提取不存在的文件（不会覆盖已有文件）

**部署后的目录结构**：
```
部署目录/
├── MetricHandel.exe    # 主程序（单文件）
├── config.ini          # 配置文件（首次运行后自动创建）
├── Models/             # 模型配置（从exe中提取，可修改）
│   ├── A长期问题小区清单.json
│   ├── B重点关注小区清单.json
│   └── ...
├── Scripts/            # SQL脚本（从exe中提取，可修改）
│   └── OverLoad.sql
├── DB/                 # 数据库目录（程序自动创建）
│   └── Data.db
└── Data/               # 数据文件目录（程序自动创建）
    └── (上传的文件)
```

### 打包后的使用

1. **直接运行**：双击 `MetricHandel.exe` 即可运行
2. **自动配置**：
   - 程序首次运行时会自动创建 `config.ini` 配置文件
   - 程序会自动从 exe 中提取 `Models/` 和 `Scripts/` 目录到配置的路径
   - 如果配置的路径不存在，会自动创建
3. **自定义配置**：编辑 `config.ini` 可以自定义：
   - 各个目录的位置（支持绝对路径和相对路径）
   - Web 服务器端口（默认 8000）

### 打包注意事项

1. **首次运行**：
   - 程序首次运行时会自动创建 `config.ini` 配置文件
   - 程序会自动从 exe 中提取 `Models/` 和 `Scripts/` 目录到配置的路径
   - 程序会自动创建 `Data/` 和 `DB/` 目录（如果配置的路径不存在）

2. **配置文件**：
   - `config.ini` 位于程序目录下，可以编辑自定义路径和端口
   - 支持绝对路径（如：`C:\Data`）和相对路径（如：`./Data`）
   - 如果路径配置为空，则使用程序当前目录下的默认文件夹

3. **资源提取**：
   - 首次运行时，如果配置的 `Models/` 或 `Scripts/` 目录不存在，会创建并提取所有文件
   - 如果目录已存在，只提取不存在的文件（不会覆盖已有文件）
   - 这样可以保护用户自定义的配置文件

4. **文件大小**：打包后的 exe 文件可能较大（通常 50-100MB），这是正常的，因为包含了所有依赖、静态资源和初始配置文件

5. **目录权限**：确保配置的目录路径有写入权限，以便程序创建和提取文件

## 常见问题

### 1. 程序无法启动

- 确保所有依赖都已正确安装：`pip install -r requirements.txt`
- 检查 Python 版本是否符合要求（3.10+）
- 查看控制台输出的错误信息

### 2. 打包失败

- 确保所有依赖都已正确安装
- 检查是否有语法错误
- 查看控制台输出的错误信息

### 3. exe 文件无法运行

- 确保程序有写入权限（用于创建配置文件和目录）
- 检查是否有杀毒软件拦截
- 查看控制台窗口的错误信息

### 4. 数据库连接失败

- 确保 `DB/` 目录存在（程序会自动创建）
- 检查是否有写入权限

## 高级配置

### 修改打包图标

在 `build.spec` 文件中，找到 `icon=None` 并修改为：
```python
icon='icon.ico',  # 你的图标文件路径
```

### 隐藏控制台窗口

在 `build.spec` 文件中，将 `console=True` 改为 `console=False`

### 添加版本信息

可以在 `build.spec` 的 `exe` 部分添加版本信息：
```python
version='version_info.txt',
```
